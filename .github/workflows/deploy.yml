name: ğŸš€ CI/CD - PDF + Image-Search Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-test-and-deploy:
    runs-on: ubuntu-latest
    env:
      # Injected from GitHub Secrets
      GHCR_USER:        ${{ secrets.GHCR_USER }}
      GHCR_TOKEN:       ${{ secrets.GHCR_TOKEN }}
      RUNPOD_API_KEY:   ${{ secrets.RUNPOD_API_KEY }}
      RUNPOD_POD_ID:    ${{ secrets.RUNPOD_POD_ID }}
      API_AUTH_TOKEN:   ${{ secrets.API_AUTH_TOKEN }}
      GPU_API_URL:      ${{ secrets.GPU_API_URL }}
      FAISS_INDEX_PATH: ${{ secrets.FAISS_INDEX_PATH }}

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install Python deps for tests
        run: |
          pip install --upgrade pip
          pip install -r docker/requirements.txt
          pip install flake8 pytest

      - name: âœ… Lint
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: ğŸ§ª Test
        run: PYTHONPATH=src pytest src/langgraphagenticai/tests

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Fly.io deploy of CPU-based PDF service
      - name: âš™ï¸ Install Fly CLI
        run: |
          curl -L https://fly.io/install.sh | sh
          echo "$HOME/.fly/bin" >> $GITHUB_PATH

      - name: ğŸ” Fly Login
        run: flyctl auth login --access-token "${{ secrets.FLY_API_TOKEN }}"

      - name: ğŸš€ Deploy PDF service
        run: |
          retry=3; count=0
          until flyctl deploy . \
               --remote-only \
               --dockerfile=./docker/Dockerfile.cpu \
               -a multi-ai-chatbot \
               --strategy immediate; do
            count=$((count+1))
            if [ $count -eq $retry ]; then
              echo "âŒ Fly deployment failed after $retry attempts" >&2
              exit 1
            fi
            echo "ğŸ” Retrying Fly deploy (#$count)â€¦"
            sleep 10
          done

      - name: ğŸ¯ PDF Service URL
        run: echo "https://multi-ai-chatbot.fly.dev"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # GPU image-search via your deploy_gpu.sh
      - name: ğŸ³ Setup Docker Buildx (needed inside deploy_gpu.sh)
        uses: docker/setup-buildx-action@v2

      - name: ğŸ” Docker login for GHCR (needed for deploy_gpu.sh)
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ env.GHCR_USER }}
          password: ${{ env.GHCR_TOKEN }}

      - name: ğŸ›  Install jq (needed for deploy_gpu.sh parsing)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: ğŸš€ Deploy GPU Image-Search Service
        run: |
          chmod +x scripts/deploy_gpu.sh
          ./scripts/deploy_gpu.sh
